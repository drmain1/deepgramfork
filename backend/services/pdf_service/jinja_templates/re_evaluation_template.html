<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Re-Evaluation Report</title>
    <style>
        /* This can be a separate CSS file loaded by WeasyPrint or included directly */
        body { font-family: sans-serif; font-size: 10pt; color: #333; }
        h2 { font-size: 16pt; color: #000; border-bottom: 2px solid #333; padding-bottom: 5px; margin-top: 20px; }
        h3 { font-size: 13pt; color: #333; margin-top: 25px; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 3px; }
        h4 { font-size: 11pt; color: #444; margin-top: 20px; margin-bottom: 8px; font-weight: bold; }
        h5 { font-size: 10pt; color: #444; margin-top: 15px; margin-bottom: 5px; font-weight: bold; text-transform: uppercase; }
        hr { border: none; border-top: 1px solid #ccc; margin: 25px 0; }
        p, .complaint-block { margin: 0 0 10px 0; line-height: 1.4; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; page-break-inside: avoid; }
        th, td { padding: 6px; border: 1px solid #495057; text-align: left; font-size: 9pt; vertical-align: top; color: #212529; }
        td b { color: #000; }
        th { background-color: #e9ecef; font-weight: bold; color: #212529; border-bottom: 2px solid #495057; }
        .text-center { text-align: center; }
        .clinic-header { text-align: right; margin-bottom: 20px; }
        .patient-bar { background-color: #e9ecef; padding: 8px; border: 1px solid #495057; margin-bottom: 20px; font-size: 9pt; color: #212529; }
        .complaint-block { margin-bottom: 15px; }
        .complaint-current { font-size: 11pt; margin-bottom: 2px; }
        .complaint-initial { font-size: 9pt; color: #666; margin-left: 10px; margin-top: 0; }
        .status-icon { font-weight: bold; font-size: 12pt; }
        .status-improved { color: #28a745; }
        .status-worsened { color: #dc3545; }
        .status-unchanged { color: #6c757d; }
        .status-new { color: #17a2b8; }
        .status-resolved { color: #007bff; }
        .status-changed { color: #ffc107; }
        .dashboard-item { margin-bottom: 20px; page-break-inside: avoid; }
        .improvement-text { font-weight: bold; padding: 3px 6px; border-radius: 4px; font-size: 9pt; }
        .progress-bar-container { background-color: #dee2e6; border: 1px solid #adb5bd; border-radius: 4px; height: 18px; margin-top: 4px; width: 100%; }
        .progress-bar { height: 100%; border-radius: 3px; }
        .progress-bar.previous { background-color: #6c757d; }
        .progress-bar.current { background-color: #198754; }
        .legend { margin-top: 10px; font-size: 8pt; color: #6c757d; }
    </style>
</head>
<body>

    <!-- Clinic Header -->
    {% if data.clinic_info %}
    <div class="clinic-header">
        <h1 style="margin: 0; font-size: 18pt; color: #333;">{{ data.clinic_info.name or '' }}</h1>
        {% if data.clinic_info.address %}
            {% set address_lines = data.clinic_info.address.replace('\\n', '\n').split('\n') %}
            {% for line in address_lines %}
                {% if line.strip() %}
                    <div style="font-size: 10pt; color: #666; margin-top: 2px;">{{ line.strip() }}</div>
                {% endif %}
            {% endfor %}
        {% endif %}
        {% if data.clinic_info.email %}
            <div style="font-size: 10pt; color: #666; margin-top: 2px;">{{ data.clinic_info.email }}</div>
        {% endif %}
        {% if data.clinic_info.phone %}
            <div style="font-size: 10pt; color: #666; margin-top: 2px;">{{ data.clinic_info.phone }}</div>
        {% endif %}
        {% if data.clinic_info.fax %}
            <div style="font-size: 10pt; color: #666; margin-top: 2px;">Fax: {{ data.clinic_info.fax }}</div>
        {% endif %}
    </div>
    {% endif %}
    <h2>RE-EVALUATION REPORT</h2>

    <!-- Patient Information Bar -->
    <div class="patient-bar">
        <strong>Patient:</strong> {{ data.patient_info.patient_name or 'N/A' }} |
        <strong>DOB:</strong> {{ data.patient_info.date_of_birth or 'N/A' }} |
        {% if data.patient_info.date_of_accident %}
        <strong>DOA:</strong> {{ data.patient_info.date_of_accident }} |
        {% endif %}
        <strong>Date of Service:</strong> {{ data.patient_info.date_of_treatment or 'N/A' }}
    </div>

    <!-- Chief Complaint & Status -->
    <h3>Chief Complaint & Status</h3>
    {% if data.sections.chief_complaint_parsed %}
        {% for complaint in data.sections.chief_complaint_parsed %}
        <div class="complaint-block">
            <p class="complaint-current">
                <strong>{{ complaint.name }}:</strong> {{ complaint.current_score|capitalize }}
                {% if complaint.comparison_status == "resolved" %}<span class="status-icon status-resolved" title="Resolved">{{ get_status_icon('resolved') }}</span>
                {% elif complaint.comparison_status == "improved" %}<span class="status-icon status-improved" title="Improved">{{ get_status_icon('improved') }}</span>
                {% elif complaint.comparison_status == "worsened" %}<span class="status-icon status-worsened" title="Worsened">{{ get_status_icon('worsened') }}</span>
                {% endif %}
            </p>
            <p class="complaint-initial">(Previous: {{ complaint.previous_score|capitalize }})</p>
        </div>
        {% endfor %}
    {% else %}
        <p>No chief complaints documented.</p>
    {% endif %}

    <!-- Discussion -->
    {% if data.sections.history_of_present_illness %}
    <h3>Discussion</h3>
    <p>{{ data.sections.history_of_present_illness }}</p>
    {% endif %}

    <hr>

    <!-- Objective Progress & Data -->
    <h3>Objective Progress & Data</h3>

    <!-- Visual Progress Dashboard for Outcome Assessments -->
    {% if data.sections.outcome_assessments_parsed %}
    <h4>Functional Outcome Assessments</h4>
    {% for assessment in data.sections.outcome_assessments_parsed %}
    <div class="dashboard-item">
        <strong>{{ assessment.name }}:
        {% if assessment.comparison_status == "improved" %}
            <span class="improvement-text status-improved">{{ assessment.improvement_percentage }}% Improvement</span>
        {% elif assessment.comparison_status == "worsened" %}
            <span class="improvement-text status-worsened">{{ -assessment.improvement_percentage }}% Worsened</span>
        {% elif assessment.comparison_status == "unchanged" %}
            <span class="improvement-text status-unchanged">No Change</span>
        {% elif assessment.comparison_status == "new" %}
            <span class="improvement-text status-new">New Assessment</span>
        {% endif %}
        </strong>

        {% if assessment.previous_percentage is not none %}
        <p style="margin: 2px 0; font-size: 9pt;">Previous: {{ assessment.previous_score_raw }} ({{ assessment.previous_percentage }}% Disabled)</p>
        <div class="progress-bar-container">
            <div class="progress-bar previous" style="width: {{ assessment.previous_percentage }}%;"></div>
        </div>
        {% endif %}

        {% if assessment.current_percentage is not none %}
        <p style="margin: 2px 0; font-size: 9pt;">Current: {{ assessment.current_score_raw }} ({{ assessment.current_percentage }}% Disabled)</p>
        <div class="progress-bar-container">
            <div class="progress-bar current" style="width: {{ assessment.current_percentage }}%;"></div>
        </div>
        {% endif %}
    </div>
    {% endfor %}
    {% endif %}

    <!-- Consolidated Physical Examination Findings -->
    <h4>Physical Examination Progress</h4>
    <div class="legend">
        Legend: <span class="status-icon status-improved">{{ get_status_icon('improved') }}</span> Improved / Resolved |
        <span class="status-icon status-worsened">{{ get_status_icon('worsened') }}</span> Worsened |
        <span class="status-icon status-unchanged">{{ get_status_icon('unchanged') }}</span> Unchanged |
        <span class="status-icon status-new">{{ get_status_icon('new') }}</span> New Finding |
        <span class="status-icon status-changed">{{ get_status_icon('changed') }}</span> Changed
    </div>

    <!-- Define a macro for the status icon to avoid repetition -->
    {% macro status_icon(status) %}
        {% if status == "improved" or status == "resolved" %}<span class="status-icon status-improved">{{ get_status_icon('improved') }}</span>
        {% elif status == "worsened" %}<span class="status-icon status-worsened">{{ get_status_icon('worsened') }}</span>
        {% elif status == "unchanged" %}<span class="status-icon status-unchanged">{{ get_status_icon('unchanged') }}</span>
        {% elif status == "new" %}<span class="status-icon status-new">{{ get_status_icon('new') }}</span>
        {% elif status == "changed" %}<span class="status-icon status-changed">{{ get_status_icon('changed') }}</span>
        {% else %}Â 
        {% endif %}
    {% endmacro %}

    <!-- Cervical Range of Motion Table -->
    {% if data.sections.cervical_rom_parsed and not data.sections.cervical_rom_all_not_documented %}
        <h5>Cervical Range of Motion</h5>
        <table>
            <thead>
                <tr>
                    <th style="width: 30%;">Movement</th>
                    <th style="width: 32%;">Previous</th>
                    <th style="width: 32%;">Current</th>
                    <th class="text-center" style="width: 6%;">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for rom in data.sections.cervical_rom_parsed %}
                <tr>
                    <td>{{ rom.movement }}</td>
                    <td>{{ rom.previous_state|capitalize }}</td>
                    <td><b>{{ rom.current_state|capitalize }}</b></td>
                    <td class="text-center">{{ status_icon(rom.comparison_status) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}

    <!-- Lumbar Range of Motion Table -->
    {% if data.sections.lumbar_rom_parsed and not data.sections.lumbar_rom_all_not_documented %}
        <h5>Lumbar Range of Motion</h5>
        <table>
            <thead>
                <tr>
                    <th style="width: 30%;">Movement</th>
                    <th style="width: 32%;">Previous</th>
                    <th style="width: 32%;">Current</th>
                    <th class="text-center" style="width: 6%;">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for rom in data.sections.lumbar_rom_parsed %}
                <tr>
                    <td>{{ rom.movement }}</td>
                    <td>{{ rom.previous_state|capitalize }}</td>
                    <td><b>{{ rom.current_state|capitalize }}</b></td>
                    <td class="text-center">{{ status_icon(rom.comparison_status) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}

    <!-- Orthopedic Tests Table -->
    {% set all_ortho_tests = data.sections.cervico_thoracic_parsed + data.sections.lumbopelvic_parsed + data.sections.extremity_parsed %}
    {% set all_ortho_not_documented = data.sections.cervico_thoracic_all_not_documented and data.sections.lumbopelvic_all_not_documented and data.sections.extremity_all_not_documented %}
    {% if all_ortho_tests and not all_ortho_not_documented %}
        <h5>Orthopedic Tests</h5>
        <table>
            <thead>
                <tr>
                    <th style="width: 30%;">Test</th>
                    <th style="width: 32%;">Previous</th>
                    <th style="width: 32%;">Current</th>
                    <th class="text-center" style="width: 6%;">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for test in all_ortho_tests %}
                <tr>
                    <td>{{ test.test_name }}</td>
                    <td>{{ test.previous_result|capitalize }}</td>
                    <td><b>{{ test.current_result|capitalize }}</b></td>
                    <td class="text-center">{{ status_icon(test.comparison_status) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}

    <!-- ===================== START OF FIX ===================== -->
    <h4>Neurological Examination Progress</h4>
    
    <!-- Motor Exam - Upper Extremity Table -->
    {% if data.motor_exam and data.motor_exam.upper_extremity_parsed and not data.motor_exam.upper_extremity_all_not_documented %}
        <h5>Motor Examination - Upper Extremity</h5>
        <table>
            <thead>
                <tr>
                    <th style="width: 22%;">Muscle</th>
                    <th class="text-center" style="width: 17%;">Right Prev</th>
                    <th class="text-center" style="width: 17%;">Right Curr</th>
                    <th class="text-center" style="width: 17%;">Left Prev</th>
                    <th class="text-center" style="width: 17%;">Left Curr</th>
                    <th class="text-center" style="width: 10%;">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for muscle in data.motor_exam.upper_extremity_parsed %}
                <tr>
                    <td>{{ muscle.muscle }}</td>
                    <td class="text-center">{{ muscle.right_previous|strip_denominator }}</td>
                    <td class="text-center"><b>{{ muscle.right_current|strip_denominator }}</b></td>
                    <td class="text-center">{{ muscle.left_previous|strip_denominator }}</td>
                    <td class="text-center"><b>{{ muscle.left_current|strip_denominator }}</b></td>
                    <td class="text-center">
                        {% set right_status = muscle.right_status %}
                        {% set left_status = muscle.left_status %}
                        {% if right_status == "improved" or left_status == "improved" %}
                            {% if right_status == "worsened" or left_status == "worsened" %}
                                {{ status_icon("changed") }}
                            {% else %}
                                {{ status_icon("improved") }}
                            {% endif %}
                        {% elif right_status == "worsened" or left_status == "worsened" %}
                            {{ status_icon("worsened") }}
                        {% elif right_status == "new" or left_status == "new" %}
                            {{ status_icon("new") }}
                        {% elif right_status == "unchanged" and left_status == "unchanged" %}
                            {{ status_icon("unchanged") }}
                        {% else %}
                            {{ status_icon("changed") }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}

    <!-- Motor Exam - Lower Extremity Table -->
    {% if data.motor_exam and data.motor_exam.lower_extremity_parsed and not data.motor_exam.lower_extremity_all_not_documented %}
        <h5>Motor Examination - Lower Extremity</h5>
        <table>
            <thead>
                <tr>
                    <th style="width: 22%;">Muscle</th>
                    <th class="text-center" style="width: 17%;">Right Prev</th>
                    <th class="text-center" style="width: 17%;">Right Curr</th>
                    <th class="text-center" style="width: 17%;">Left Prev</th>
                    <th class="text-center" style="width: 17%;">Left Curr</th>
                    <th class="text-center" style="width: 10%;">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for muscle in data.motor_exam.lower_extremity_parsed %}
                <tr>
                    <td>{{ muscle.muscle }}</td>
                    <td class="text-center">{{ muscle.right_previous|strip_denominator }}</td>
                    <td class="text-center"><b>{{ muscle.right_current|strip_denominator }}</b></td>
                    <td class="text-center">{{ muscle.left_previous|strip_denominator }}</td>
                    <td class="text-center"><b>{{ muscle.left_current|strip_denominator }}</b></td>
                    <td class="text-center">
                        {% set right_status = muscle.right_status %}
                        {% set left_status = muscle.left_status %}
                        {% if right_status == "improved" or left_status == "improved" %}
                            {% if right_status == "worsened" or left_status == "worsened" %}
                                {{ status_icon("changed") }}
                            {% else %}
                                {{ status_icon("improved") }}
                            {% endif %}
                        {% elif right_status == "worsened" or left_status == "worsened" %}
                            {{ status_icon("worsened") }}
                        {% elif right_status == "new" or left_status == "new" %}
                            {{ status_icon("new") }}
                        {% elif right_status == "unchanged" and left_status == "unchanged" %}
                            {{ status_icon("unchanged") }}
                        {% else %}
                            {{ status_icon("changed") }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}

    <!-- Reflexes - Deep Tendon Table -->
    {% if data.reflexes and data.reflexes.deep_tendon_parsed and not data.reflexes.deep_tendon_all_not_documented %}
        <h5>Reflexes - Deep Tendon</h5>
        <table>
            <thead>
                <tr>
                    <th style="width: 22%;">Reflex</th>
                    <th class="text-center" style="width: 17%;">Right Prev</th>
                    <th class="text-center" style="width: 17%;">Right Curr</th>
                    <th class="text-center" style="width: 17%;">Left Prev</th>
                    <th class="text-center" style="width: 17%;">Left Curr</th>
                    <th class="text-center" style="width: 10%;">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for reflex in data.reflexes.deep_tendon_parsed %}
                <tr>
                    <td>{{ reflex.reflex }}</td>
                    <td class="text-center">{{ reflex.right_previous }}</td>
                    <td class="text-center"><b>{{ reflex.right_current }}</b></td>
                    <td class="text-center">{{ reflex.left_previous }}</td>
                    <td class="text-center"><b>{{ reflex.left_current }}</b></td>
                    <td class="text-center">
                        {% set right_status = reflex.right_status %}
                        {% set left_status = reflex.left_status %}
                        {% if right_status == "improved" or left_status == "improved" %}
                            {% if right_status == "worsened" or left_status == "worsened" %}
                                {{ status_icon("changed") }}
                            {% else %}
                                {{ status_icon("improved") }}
                            {% endif %}
                        {% elif right_status == "worsened" or left_status == "worsened" %}
                            {{ status_icon("worsened") }}
                        {% elif right_status == "new" or left_status == "new" %}
                            {{ status_icon("new") }}
                        {% elif right_status == "unchanged" and left_status == "unchanged" %}
                            {{ status_icon("unchanged") }}
                        {% else %}
                            {{ status_icon("changed") }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}

    <!-- Reflexes - Pathological Table -->
    {% if data.reflexes and data.reflexes.pathological_parsed and not data.reflexes.pathological_all_not_documented %}
        <h5>Reflexes - Pathological</h5>
        <table>
            <thead>
                <tr>
                    <th style="width: 22%;">Reflex</th>
                    <th class="text-center" style="width: 17%;">Right Prev</th>
                    <th class="text-center" style="width: 17%;">Right Curr</th>
                    <th class="text-center" style="width: 17%;">Left Prev</th>
                    <th class="text-center" style="width: 17%;">Left Curr</th>
                    <th class="text-center" style="width: 10%;">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for reflex in data.reflexes.pathological_parsed %}
                <tr>
                    <td>{{ reflex.reflex }}</td>
                    <td class="text-center">{{ reflex.right_previous }}</td>
                    <td class="text-center"><b>{{ reflex.right_current }}</b></td>
                    <td class="text-center">{{ reflex.left_previous }}</td>
                    <td class="text-center"><b>{{ reflex.left_current }}</b></td>
                    <td class="text-center">
                        {% set right_status = reflex.right_status %}
                        {% set left_status = reflex.left_status %}
                        {% if right_status == "improved" or left_status == "improved" %}
                            {% if right_status == "worsened" or left_status == "worsened" %}
                                {{ status_icon("changed") }}
                            {% else %}
                                {{ status_icon("improved") }}
                            {% endif %}
                        {% elif right_status == "worsened" or left_status == "worsened" %}
                            {{ status_icon("worsened") }}
                        {% elif right_status == "new" or left_status == "new" %}
                            {{ status_icon("new") }}
                        {% elif right_status == "unchanged" and left_status == "unchanged" %}
                            {{ status_icon("unchanged") }}
                        {% else %}
                            {{ status_icon("changed") }}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}

    <!-- Cranial Nerve Examination Table -->
    {% if data.cranial_nerve_examination_parsed and not data.cranial_nerve_examination_all_not_documented %}
        <h5>Cranial Nerves</h5>
        <table>
            <thead>
                <tr>
                    <th style="width: 30%;">Nerve</th>
                    <th style="width: 32%;">Previous</th>
                    <th style="width: 32%;">Current</th>
                    <th class="text-center" style="width: 6%;">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for cn in data.cranial_nerve_examination_parsed %}
                <tr>
                    <td>{{ cn.cranial_nerve }}</td>
                    <td>{{ cn.previous_finding|capitalize }}</td>
                    <td><b>{{ cn.current_finding|capitalize }}</b></td>
                    <td class="text-center">{{ status_icon(cn.comparison_status) }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}
    <!-- ===================== END OF FIX ===================== -->

    {% if data.sections.sensory_examination %}
        <h5>Sensory Examination</h5>
        <p>{{ data.sections.sensory_examination }}</p>
    {% endif %}
    
    {% if data.postural_and_gait_analysis and (data.postural_and_gait_analysis.posture_general or data.postural_and_gait_analysis.gait_analysis) %}
    <h4>Postural & Gait Analysis</h4>
    {% if data.postural_and_gait_analysis.posture_general %}
    <p><strong>Posture:</strong> {{ data.postural_and_gait_analysis.posture_general }}</p>
    {% endif %}
    {% if data.postural_and_gait_analysis.gait_analysis %}
    <p><strong>Gait:</strong> {{ data.postural_and_gait_analysis.gait_analysis }}</p>
    {% endif %}
    {% endif %}


    <hr>

    <!-- Assessment & Plan -->
    <h3>Assessment & Plan</h3>
    
    {% if data.sections.assessment_diagnosis %}
    <h4>Diagnosis</h4>
        {% for dx in data.sections.assessment_diagnosis %}
        <p>- {{ dx.diagnosis }} ({{ dx.icd10_code }}) - {{ dx.status }}</p>
        {% endfor %}
    {% endif %}
    
    {% if data.sections.plan %}
    <h4>Plan</h4>
    <p>{{ data.sections.plan.replace('\n', '<br>') | safe }}</p>
    {% endif %}

    <!-- Treatment Performed Today -->
    {% if data.sections.treatment_performed_today %}
    <h4>Treatment Performed Today</h4>
    <p>{{ data.sections.treatment_performed_today.replace('\n', '<br>') | safe }}</p>
    {% endif %}

</body>
</html>