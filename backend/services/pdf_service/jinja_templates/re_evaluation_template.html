<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Re-Evaluation Report</title>
    <style>
        {{ css_styles }}
    </style>
</head>
<body>

    <!-- Clinic Header -->
    {% if data.clinic_info %}
    <div class="clinic-header">
        {% if data.clinic_info.lines %}
            <!-- Display each line of office information as entered by user -->
            {% for line in data.clinic_info.lines %}
            <div class="clinic-info-line" style="font-size: {% if loop.first %}18pt{% else %}10pt{% endif %}; font-weight: {% if loop.first %}bold{% else %}normal{% endif %}; color: {% if loop.first %}#333{% else %}#666{% endif %}; margin-top: {% if loop.first %}0{% else %}5px{% endif %};">
                {{ line }}
            </div>
            {% endfor %}
        {% else %}
            <!-- Fallback to individual fields for compatibility -->
            {% if data.clinic_info.name %}
            <h1 style="margin: 0; font-size: 18pt; color: #333;">{{ data.clinic_info.name }}</h1>
            {% endif %}
            {% if data.clinic_info.address %}
            <div class="clinic-address" style="font-size: 10pt; color: #666; margin-top: 5px;">{{ data.clinic_info.address }}</div>
            {% endif %}
            {% if data.clinic_info.phone or data.clinic_info.fax %}
            <div class="clinic-contact" style="font-size: 10pt; color: #666; margin-top: 2px;">
                {% if data.clinic_info.phone %}Tel: {{ data.clinic_info.phone }}{% endif %}
                {% if data.clinic_info.phone and data.clinic_info.fax %} | {% endif %}
                {% if data.clinic_info.fax %}Fax: {{ data.clinic_info.fax }}{% endif %}
            </div>
            {% endif %}
            {% if data.clinic_info.email %}
            <div class="clinic-contact" style="font-size: 10pt; color: #666; margin-top: 2px;">{{ data.clinic_info.email }}</div>
            {% endif %}
        {% endif %}
    </div>
    {% endif %}
    <h2>RE-EVALUATION REPORT</h2>

    <!-- Patient Information Bar -->
    <div class="patient-bar">
        <strong>Patient:</strong> {{ data.patient_info.patient_name or 'N/A' }} | 
        <strong>DOB:</strong> {{ data.patient_info.date_of_birth or 'N/A' }} | 
        {% if data.patient_info.date_of_accident %}
        <strong>DOA:</strong> {{ data.patient_info.date_of_accident }} | 
        {% endif %}
        <strong>Date of Service:</strong> {{ data.patient_info.date_of_treatment or 'N/A' }}
    </div>

    <!-- Chief Complaint & Status -->
    <h3>Chief Complaint & Status</h3>
    {% if data.sections.chief_complaint %}
        {% set complaint_text = data.sections.chief_complaint %}
        
        <!-- Process each line separately -->
        {% for line in complaint_text.split('\n') %}
            {% if line.strip() %}
                <div class="complaint-block">
                    {% set clean_line = line.strip() %}
                    
                    {% if '|' in clean_line %}
                        <!-- Split on pipe character -->
                        {% set before_pipe = clean_line.split('|')[0].strip() %}
                        {% set after_pipe = clean_line.split('|')[1].strip() %}
                        
                        <!-- Extract complaint name (everything before and including first colon) -->
                        {% if ':' in before_pipe %}
                            {% set complaint_parts = before_pipe.split(':') %}
                            {% set complaint_name = complaint_parts[0].strip() %}
                            {% set prev_text = complaint_parts[1].strip() %}
                            
                            <!-- Remove "Previously" if present -->
                            {% if prev_text.startswith('Previously') %}
                                {% set prev_text = prev_text[10:].strip() %}
                            {% endif %}
                            
                            <!-- Remove "Currently" from after pipe if present -->
                            {% set curr_text = after_pipe %}
                            {% if curr_text.startswith('Currently') %}
                                {% set curr_text = curr_text[9:].strip() %}
                            {% endif %}
                            
                            <p class="complaint-current"><strong>{{ complaint_name }}:</strong> {{ curr_text }}</p>
                            <p class="complaint-initial">(Initial: {{ prev_text }})</p>
                        {% else %}
                            <!-- Fallback if no colon found -->
                            <p class="complaint-current">{{ clean_line }}</p>
                        {% endif %}
                    {% else %}
                        <!-- No pipe, display as is -->
                        <p class="complaint-current">{{ clean_line }}</p>
                    {% endif %}
                </div>
            {% endif %}
        {% endfor %}
    {% else %}
        <p>No chief complaints documented.</p>
    {% endif %}

    <!-- History of Present Illness -->
    {% if data.sections.history_of_present_illness %}
    <h3>History of Present Illness</h3>
    <p>{{ data.sections.history_of_present_illness }}</p>
    {% endif %}

    <hr>

    <!-- Objective Progress & Data -->
    <h3>Objective Progress & Data</h3>

    <!-- Visual Progress Dashboard -->
    {% if data.sections.outcome_assessments %}
    <h4>Visual Progress Dashboard</h4>
    {% set outcome_text = data.sections.outcome_assessments %}
    
    <!-- Split by periods to handle multiple assessments -->
    {% set assessments = [] %}
    {% if '. ' in outcome_text %}
        {% set assessments = outcome_text.split('. ') %}
    {% else %}
        {% set assessments = [outcome_text] %}
    {% endif %}
    
    <!-- Process each assessment (up to 3) -->
    {% for assessment_text in assessments[:3] %}
        {% if assessment_text.strip() %}
            <!-- Try to parse the assessment data -->
            {% set ns = namespace(parsed_successfully=false) %}
            
            <!-- Clean up the assessment text (remove trailing periods) -->
            {% set assessment_text = assessment_text.strip().rstrip('.') %}
            
            <!-- Parse format: "Neck Disability Index: Previously 31/50, currently 25/50" -->
            {% if ":" in assessment_text %}
                {% set parts = assessment_text.split(':', 1) %}
                {% set assessment_name = parts[0].strip() %}
                {% set values_part = parts[1].strip() if parts|length > 1 else "" %}
                
                {% set initial_score = "" %}
                {% set current_score = "" %}
                {% set initial_percentage = 0 %}
                {% set current_percentage = 0 %}
                {% set improvement_percentage = 0 %}
                
                <!-- Parse "Previously 31/50, currently 25/50" or "Previously 31/50 | Current: 25/50" formats -->
                {% if "Previously" in values_part and ("currently" in values_part or "Current:" in values_part) %}
                    {% if "currently" in values_part %}
                        {% set prev_part = values_part.split('currently')[0].replace('Previously', '').strip().rstrip(',') %}
                        {% set curr_part = values_part.split('currently')[1].strip() %}
                    {% elif "Current:" in values_part %}
                        {% set prev_part = values_part.split('|')[0].replace('Previously', '').strip() if '|' in values_part else values_part.replace('Previously', '').strip() %}
                        {% set curr_part = values_part.split('Current:')[1].strip() if 'Current:' in values_part else "" %}
                    {% endif %}
                    
                    <!-- Extract scores like "31/50" from potentially complex text like "31/50 (62%)" -->
                    {% if "/" in prev_part %}
                        <!-- Extract just the fraction part before any parentheses -->
                        {% set fraction_match = prev_part.split('(')[0].strip() %}
                        {% set prev_nums = fraction_match.split('/') %}
                        {% if prev_nums|length >= 2 and prev_nums[0].strip().isdigit() and prev_nums[1].strip().isdigit() %}
                            {% set initial_numerator = prev_nums[0].strip()|int %}
                            {% set initial_denominator = prev_nums[1].strip()|int %}
                            {% if initial_denominator > 0 %}
                                {% set initial_score = initial_numerator|string + "/" + initial_denominator|string %}
                                {% set initial_percentage = ((initial_numerator / initial_denominator) * 100)|round|int %}
                            {% endif %}
                        {% endif %}
                    {% endif %}
                    
                    {% if "/" in curr_part %}
                        <!-- Extract just the fraction part before any parentheses -->
                        {% set fraction_match = curr_part.split('(')[0].strip() %}
                        {% set curr_nums = fraction_match.split('/') %}
                        {% if curr_nums|length >= 2 and curr_nums[0].strip().isdigit() and curr_nums[1].strip().isdigit() %}
                            {% set current_numerator = curr_nums[0].strip()|int %}
                            {% set current_denominator = curr_nums[1].strip()|int %}
                            {% if current_denominator > 0 %}
                                {% set current_score = current_numerator|string + "/" + current_denominator|string %}
                                {% set current_percentage = ((current_numerator / current_denominator) * 100)|round|int %}
                            {% endif %}
                        {% endif %}
                    {% endif %}
                    
                    <!-- Calculate improvement percentage -->
                    {% if initial_percentage > 0 and current_percentage >= 0 %}
                        {% set improvement_percentage = ((initial_percentage - current_percentage) / initial_percentage * 100)|round|int %}
                    {% endif %}
                {% endif %}
                
                <div class="dashboard-item" style="margin-bottom: 15px;">
                    <strong>{{ assessment_name }}: 
                    {% if improvement_percentage > 0 %}
                    <span class="improvement-text">{{ improvement_percentage }}% Improvement</span>
                    {% elif improvement_percentage < 0 %}
                    <span class="improvement-text" style="color: #dc3545;">{{ -improvement_percentage }}% Worsened</span>
                    {% elif initial_score and current_score and initial_percentage == current_percentage %}
                    <span class="improvement-text" style="color: #6c757d;">No Change</span>
                    {% endif %}
                    </strong>
                    
                    {% if initial_score and initial_percentage >= 0 %}
                    <p style="margin: 2px 0; font-size: 9pt;">Initial: {{ initial_score }} ({{ initial_percentage }}% Disabled)</p>
                    <div class="progress-bar-container" style="background-color: #e9ecef; border-radius: 4pt; height: 18pt; margin-top: 4pt; margin-bottom: 8pt;">
                        <div class="progress-bar" style="background-color: #ced4da; height: 100%; border-radius: 4pt; width: {{ initial_percentage }}%;"></div>
                    </div>
                    {% endif %}
                    
                    {% if current_score and current_percentage >= 0 %}
                    <p style="margin: 2px 0; font-size: 9pt;">Current: {{ current_score }} ({{ current_percentage }}% Disabled)</p>
                    <div class="progress-bar-container" style="background-color: #e9ecef; border-radius: 4pt; height: 18pt; margin-top: 4pt; margin-bottom: 8pt;">
                        <div class="progress-bar current" style="background-color: #28a745; height: 100%; border-radius: 4pt; width: {{ current_percentage }}%;"></div>
                    </div>
                    {% endif %}
                    
                    <!-- Mark as successfully parsed if we have at least one score -->
                    {% if initial_score or current_score %}
                        {% set ns.parsed_successfully = true %}
                    {% endif %}
                    
                    <!-- If parsing failed for this assessment, show the raw text -->
                    {% if not ns.parsed_successfully %}
                        <p style="margin-left: 20px;">{{ values_part }}</p>
                    {% endif %}
                </div>
            {% else %}
                <!-- No colon found, just display the text -->
                <div class="dashboard-item" style="margin-bottom: 15px;">
                    <p>{{ assessment_text }}</p>
                </div>
            {% endif %}
        {% endif %}
    {% endfor %}
    
    {% endif %}

    <!-- Consolidated Physical Examination Findings -->
    <h4>Physical Examination Progress</h4>
    
    <!-- Collect all positive findings from various sections -->
    {% set all_findings = [] %}
    
    <!-- Process orthopedic/special tests from different body regions -->
    {% for section_name, section_data in [
        ("Cervico-thoracic", data.sections.cervico_thoracic), 
        ("Lumbopelvic", data.sections.lumbopelvic), 
        ("Extremity", data.sections.extremity), 
        ("Sensory", data.sections.sensory_examination)
    ] %}
        {% if section_data %}
            {% set findings = section_data.split('\n') %}
            {% for finding in findings %}
                {% set finding = finding.strip() %}
                {% if finding and ':' in finding and ('Previously' in finding or 'currently' in finding) %}
                    {% set parts = finding.split(':', 1) %}
                    {% if parts|length >= 2 %}
                        {% set finding_dict = {'category': section_name, 'name': parts[0].strip(), 'states': parts[1].strip()} %}
                        {% set _ = all_findings.append(finding_dict) %}
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endfor %}
    
    <!-- Process motor examination findings -->
    {% if data.motor_exam %}
        <!-- Upper extremity -->
        {% if data.motor_exam.upper_extremity %}
            {% for muscle in data.motor_exam.upper_extremity %}
                {% if muscle.right and muscle.right != "Not documented" and ('Previously' in muscle.right or '/' in muscle.right) %}
                    {% set finding_dict = {'category': 'Motor - Upper', 'name': muscle.muscle + ' (R)', 'states': muscle.right} %}
                    {% set _ = all_findings.append(finding_dict) %}
                {% endif %}
                {% if muscle.left and muscle.left != "Not documented" and ('Previously' in muscle.left or '/' in muscle.left) %}
                    {% set finding_dict = {'category': 'Motor - Upper', 'name': muscle.muscle + ' (L)', 'states': muscle.left} %}
                    {% set _ = all_findings.append(finding_dict) %}
                {% endif %}
            {% endfor %}
        {% endif %}
        
        <!-- Lower extremity -->
        {% if data.motor_exam.lower_extremity %}
            {% for muscle in data.motor_exam.lower_extremity %}
                {% if muscle.right and muscle.right != "Not documented" and ('Previously' in muscle.right or '/' in muscle.right) %}
                    {% set finding_dict = {'category': 'Motor - Lower', 'name': muscle.muscle + ' (R)', 'states': muscle.right} %}
                    {% set _ = all_findings.append(finding_dict) %}
                {% endif %}
                {% if muscle.left and muscle.left != "Not documented" and ('Previously' in muscle.left or '/' in muscle.left) %}
                    {% set finding_dict = {'category': 'Motor - Lower', 'name': muscle.muscle + ' (L)', 'states': muscle.left} %}
                    {% set _ = all_findings.append(finding_dict) %}
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endif %}
    
    <!-- Process reflex findings -->
    {% if data.reflexes %}
        {% if data.reflexes.deep_tendon %}
            {% for reflex in data.reflexes.deep_tendon %}
                {% if reflex.right and reflex.right != "Not documented" and ('Previously' in reflex.right or '+' in reflex.right) %}
                    {% set finding_dict = {'category': 'Reflexes', 'name': reflex.reflex + ' (R)', 'states': reflex.right} %}
                    {% set _ = all_findings.append(finding_dict) %}
                {% endif %}
                {% if reflex.left and reflex.left != "Not documented" and ('Previously' in reflex.left or '+' in reflex.left) %}
                    {% set finding_dict = {'category': 'Reflexes', 'name': reflex.reflex + ' (L)', 'states': reflex.left} %}
                    {% set _ = all_findings.append(finding_dict) %}
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endif %}
    
    <!-- Display consolidated findings table if we have any positive findings -->
    {% if all_findings %}
    <p style="margin-bottom: 10px;">Previously positive findings compared with current status:</p>
    
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background-color: #f8f9fa;">
                <th style="width: 20%; padding: 8px; text-align: left; border: 1px solid #dee2e6;">Category</th>
                <th style="width: 30%; padding: 8px; text-align: left; border: 1px solid #dee2e6;">Finding</th>
                <th style="width: 20%; padding: 8px; text-align: left; border: 1px solid #dee2e6;">Initial State</th>
                <th style="width: 20%; padding: 8px; text-align: left; border: 1px solid #dee2e6;">Current State</th>
                <th style="width: 10%; padding: 8px; text-align: center; border: 1px solid #dee2e6;">Status</th>
            </tr>
        </thead>
        <tbody>
            {% for finding in all_findings %}
                {% set prev_state = "" %}
                {% set curr_state = "" %}
                {% set improvement_status = "" %}
                
                <!-- Parse the states string -->
                {% set states = finding.states %}
                
                <!-- Handle "Previously X | Currently Y" format -->
                {% if 'Previously' in states and '|' in states and ('Currently' in states or 'Current:' in states) %}
                    {% set pipe_parts = states.split('|') %}
                    {% if pipe_parts|length >= 2 %}
                        {% set prev_state = pipe_parts[0].replace('Previously', '').strip() %}
                        {% set curr_state = pipe_parts[1].replace('Currently', '').replace('Current:', '').strip().rstrip('.') %}
                    {% endif %}
                    
                <!-- Handle "Previously X, currently Y" format (for motor strength) -->
                {% elif 'Previously' in states and 'currently' in states %}
                    {% set state_parts = states.split('currently') %}
                    {% if state_parts|length >= 2 %}
                        {% set prev_state = state_parts[0].replace('Previously', '').replace(',', '').strip() %}
                        {% set curr_state = state_parts[1].strip().rstrip('.') %}
                    {% endif %}
                
                <!-- Handle direct comparison format (e.g., "4+/5" for current only) -->
                {% elif '/' in states and 'Previously' not in states %}
                    {% set prev_state = "Not previously tested" %}
                    {% set curr_state = states %}
                {% endif %}
                
                <!-- Determine improvement status -->
                {% if prev_state and curr_state %}
                    {% if 'normal' in curr_state.lower() or 'negative' in curr_state.lower() or '5/5' in curr_state %}
                        {% set improvement_status = "improved" %}
                    {% elif prev_state == curr_state %}
                        {% set improvement_status = "unchanged" %}
                    {% elif 'positive' in curr_state.lower() and 'negative' in prev_state.lower() %}
                        {% set improvement_status = "worsened" %}
                    {% else %}
                        {% set improvement_status = "changed" %}
                    {% endif %}
                {% endif %}
                
                {% if prev_state and curr_state %}
                <tr>
                    <td style="padding: 6px; border: 1px solid #dee2e6; font-size: 9pt;">{{ finding.category }}</td>
                    <td style="padding: 6px; border: 1px solid #dee2e6; font-size: 9pt;">{{ finding.name }}</td>
                    <td style="padding: 6px; border: 1px solid #dee2e6; font-size: 9pt;">{{ prev_state|capitalize }}</td>
                    <td style="padding: 6px; border: 1px solid #dee2e6; font-size: 9pt; font-weight: bold;">{{ curr_state|capitalize }}</td>
                    <td style="padding: 6px; border: 1px solid #dee2e6; text-align: center; font-size: 9pt;">
                        {% if improvement_status == "improved" %}
                            <span style="color: #28a745;">✓</span>
                        {% elif improvement_status == "worsened" %}
                            <span style="color: #dc3545;">✗</span>
                        {% elif improvement_status == "unchanged" %}
                            <span style="color: #6c757d;">→</span>
                        {% else %}
                            <span style="color: #6c757d;">•</span>
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>
    
    <p style="margin-top: 10px; font-size: 8pt; color: #6c757d;">
        Legend: ✓ = Improved, ✗ = Worsened, → = No change, • = Status changed
    </p>
    {% else %}
        <p>{{ data.sections.physical_examination or "No specific comparative findings documented for this re-evaluation." }}</p>
    {% endif %}

    <hr>

    <!-- Assessment & Plan -->
    <h3>Assessment & Plan</h3>
    
    {% if data.sections.assessment_diagnosis %}
    <h4>Diagnosis</h4>
    <p class="diagnosis-list">{{ data.sections.assessment_diagnosis }}</p>
    {% endif %}
    
    {% if data.sections.plan %}
    <h4>Plan</h4>
    <p>{{ data.sections.plan }}</p>
    {% endif %}

    <!-- Treatment Performed Today -->
    {% if data.sections.treatment_performed_today %}
    <h4>Treatment Performed Today</h4>
    <p>{{ data.sections.treatment_performed_today }}</p>
    {% endif %}

</body>
</html>